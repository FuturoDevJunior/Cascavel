# plugins/exploit_auto.py
def run(target, ip, open_ports, banners):
    """
    Busca exploits recentes associados ao alvo consultando a API pública do cve.circl.lu.
    Retorna os 10 primeiros CVEs encontrados, incluindo resumo, CVSS e referências.
    """
    import requests

    exploits = []
    try:
        base_url = "https://cve.circl.lu/api/search/"
        query = target.split('.')[0]
        resp = requests.get(f"{base_url}{query}", timeout=20)
        if resp.ok:
            data = resp.json()
            for cve in data.get('results', [])[:10]:
                exploits.append({
                    "id": cve.get("id", ""),
                    "resumo": cve.get("summary", ""),
                    "cvss": cve.get("cvss", ""),
                    "referencias": cve.get("references", [])
                })
        else:
            exploits.append({"erro": "Falha ao consultar a API CVE"})
    except Exception as e:
        exploits.append({"erro": f"Exceção: {str(e)}"})

    return {
        "plugin": "exploit_auto",
        "exploits": exploits if exploits else "Nenhum exploit encontrado"
    }
